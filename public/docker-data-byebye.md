---
title: 本番と開発を間違えた話
tags:
  - AWS
  - GCE
  - 本番環境でやらかしたこと
private: true
updated_at: '2025-12-02T09:47:19+09:00'
id: 505025e1101716fb1801
organization_url_name: null
slide: false
ignorePublish: false
---
:::note info
この記事は[本番環境などでやらかしちゃった人 Advent Calendar 2025](https://qiita.com/advent-calendar/2025/yarakashi)の11日目の内容です（忘れてなければ）
:::
# ちょっと大きめのサーバーのデータをキレイキレイしてしまった話。

こんにちは、おかかです。
今回は、ちょっと大きめのサーバーのデータを全て飛ばしてしまった件について書いていきたいと思います。
(名前は言えませんが、結構大きすぎるやらかしです。時効のはずなので書きます)

## 第一章 平和な日常
まず、サーバーの構成についてです。
EC2(m5n.2xlarge * 2)
GCE(c4a-standard-4 * 2)
の系4つで動作していてEC2が1つ+GCEが1つ計2つで、それぞれ本番環境と開発環境で分かれていました。
基本ネットワークもサーバーのホスト名も全く違うので間違えてしまうことはないはずでした。そう、この時までは

## 第二章 異変の始まり
普段、開発サーバーでは複数人で開発を進めていて、テストごとに前使ったものは全て抹消し、まっさらな状態にしてからもう一度最初からテストをする形式でしていました。
本番環境と開発環境は構成(さっきのネットワーク系以外)は全くと言っていいほど同じで、ホスト名とIPを見ない限り簡単に間違えるようなものでした。
まあ、少しでも変えてればこんなことにはならなかったんですけどね！

開発環境のデータを飛ばす日になり、いつもやっていた作業だったのでほんとに10分で終わるぐらい簡単なものでした。
内容はリセットなので、動作中の物を止める->MariaDBを止める->全部ファイルも飛ばす->ビルドしたファイルを置く->MariaDBを起動->新しく置いた物を起動(テスト)->IPにアクセスして動作チェック
これを開発環境で置く予定だったのですが、なんと本番環境で行なってしまいました。
全部ファイルを飛ばしているので、もちろん他のデータも全て飛んでDBも飛んでしまいました。
アラートが鳴り、作業終了から3分後に発覚しました。
## 第三章 復旧

## 今回のへまったこと（やらかし）
- スナップショットが保存できたこと確認していなかった
- ダウン通知が来るのが遅く気が付くまで時間がかかった

## このやらかしを起こさないために
- スナップショットが保存できたことを完全に確認してから行う。
- ダウン通知をもう少し早く出るようにする。
- クラスターやNodeを増やすなりしてデータを複数の場所に置き守る。


## 最後に
Dockerのコンテナがこんな風になるのは結構前からあったんですけど、正直謎なんですよね。
もし何かお知りのことことがあればぜひ教えていただきたいです！
皆さんももしdockerで重ためのことをする場合はお気を付けください！
（書いてるラストに気づいたんですけど、`docker compose down`と`docker stop`は10秒でkill入ったような気がしてます。40秒でkillしたのは意味なかったですね、10秒killでデータ死んだのかな？）
いやぁなんでMinio落ちたんだろうなー
