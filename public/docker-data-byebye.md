---
title: Dockerでデータ無事破損
tags:
  - Elasticsearch
  - Docker
  - 本番環境でやらかしたこと
private: true
updated_at: '2025-11-23T23:58:38+09:00'
id: 505025e1101716fb1801
organization_url_name: null
slide: false
ignorePublish: false
---
:::note info
この記事は[本番環境などでやらかしちゃった人 Advent Calendar 2025](https://qiita.com/advent-calendar/2025/yarakashi)の11日目の内容です（忘れてなければ）
:::
# Dockerでcomposeをしたときにデータを破損してしまった話

こんにちは、おかかです。
今回はDocker composeでデータを**本番環境で破損**してしまったので、ご紹介します。（ちなみにこの記事を書き始めたのが11/21のPM11時なのですが、起こったのはおとといのPM5時です）

## なぜデータを破損してしまったのか。普通はそう壊れないのでは？
まず、自分の構成について少し解説します。

- オンプレ 1Node 1Cluster (Master&Data)
- OCI Minio Backup (無料枠!!)

とてもシンプルでいい構成ですよね？
このOCIが後々出てきます。覚えといてください。
ちなみにOCIではほかにGrafanaと、Webサイトが動いてます。

## まず事の経緯

- 19日 17時
なぜかGrafanaを見ると前日からインデックス数が増えていない。
確認するとインデックスの同時オープン数？的な何かしらの制限を突破しインデックスを作成できなくなっていた。上限を一時的に倍にして対応。
- 19日 17時半
Elasticでコンテナの再起動を伴う作業が発生したためここで**OCIのMinio**にスナップショットを保存して**出来ているはずだった**。
- 19日 17時36分
作業開始。Elasticsearchのコンテナを`docker compose down elasticsearch`で停止。この時ちょうどGrafana経由でDiscordにMinioが落ちているという通知が届く。普通だったらMinioを起動させて**停止されるはず**のElasticsearchの設定を変更し`docker compose up -d`を実行すればいいものの、Minioを再起動している間にElasticsearchが停止しない。
![notdownelastic.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3113699/1b9cdf28-4c6a-4567-9c6f-d0cbcdda4323.png)
中のプロセスは既にstopしているが、40秒立ってもコンテナが止まらないためkillを回した。それでも止まらない。
- 19日 17時40分ぐらい
最終手段dockerデーモン再起動、これ以外のコンテナも動作不安定に。
Kibanaアクセス時インデックス数が本来の2/3に。ここで、スナップショットから戻せば問題ないやろーー余裕やんけ！と思った自分なんとMinioがスナップショット保存中に落ちていたことを思い出す。無事にデータがMinio側もデータが破損していてスナップショットが復元できずに終了。

## 今回のへまったこと（やらかし）
- スナップショットが保存できたこと確認していなかった
- ダウン通知が来るのが遅く気が付くまで時間がかかった

## このやらかしを起こさないために
- スナップショットが保存できたことを完全に確認してから行う。
- ダウン通知をもう少し早く出るようにする。
- クラスターやNodeを増やすなりしてデータを複数の場所に置き守る。


## 最後に
Dockerのコンテナがこんな風になるのは結構前からあったんですけど、正直謎なんですよね。
もし何かお知りのことことがあればぜひ教えていただきたいです！
皆さんももしdockerで重ためのことをする場合はお気を付けください！
（ラストに気づいたんですけど、`docker compose down`と`docker stop`は10秒でkill入ったような気がしてます。40秒でkillしたのは意味なかったですね）
